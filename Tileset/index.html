<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tilemap with collision</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.16.2/dist/phaser.js"></script>
</head>
<body>

    <script>
        const config = {
            type: Phaser.AUTO, // Which renderer to use
            // width: 800, // Canvas width in pixels
            // height: 600, // Canvas height in pixels
            parent: "game-container", // ID of the DOM element to add the canvas to
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            scale: {
                parent: "game-container",
                mode: Phaser.Scale.FIT,
                width: window.innerWidth,
                height: window.innerHeight
            },
            physics: {
                default: 'arcade',
                // Set gravity to 0 because it is a top-down game (no gravity needed).
                arcade: {
                    gravity: { y: 0},
                }
            }
        };

        let game = new Phaser.Game(config);
        let player;

        function preload() {
            // Runs once, loads up assets like images and audio
            this.load.image("mario-tiles", "assets/mario-tiles.png");
            this.load.image('idle1', 'assets/idle/Idle (1).png');
            this.load.image('idle2', 'assets/idle/Idle (2).png');
            this.load.image('idle3', 'assets/idle/Idle (3).png');
            this.load.image('idle4', 'assets/idle/Idle (4).png');
            this.load.image('idle5', 'assets/idle/Idle (5).png');
            this.load.image('idle6', 'assets/idle/Idle (6).png');
            this.load.image('idle7', 'assets/idle/Idle (7).png');
            this.load.image('idle8', 'assets/idle/Idle (8).png');
            this.load.image('idle9', 'assets/idle/Idle (9).png');
            this.load.image('idle10', 'assets/idle/Idle (10).png');
            this.load.image('run1', 'assets/run/0001.png');
            this.load.image('run2', 'assets/run/0002.png');
            this.load.image('run3', 'assets/run/0003.png');
            this.load.image('run4', 'assets/run/0004.png');
            this.load.image('run5', 'assets/run/0005.png');
            this.load.image('run6', 'assets/run/0006.png');
            this.load.image('run7', 'assets/run/0007.png');
            this.load.image('run8', 'assets/run/0008.png');
            this.load.image('run9', 'assets/run/0009.png');
            this.load.image('run10', 'assets/run/0010.png');
        }

        function create() {
            // Runs once, after all assets in preload are loaded
            let level = [
                [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 ],
                [  0,   1,   2,   3,   0,   0,   0,   1,   2,   3,   0 ],
                [  0,   5,   6,   7,   0,   0,   0,   5,   6,   7,   0 ],
                [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 ],
                [  0,   0,   0,  14,  13,  14,   0,   0,   0,   0,   0 ],
                [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 ],
                [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 ],
                [  0,   0,  14,  14,  14,  14,  14,   0,   0,   0,  15 ],
                [  0,   0,   0,   0,   0,   0,   0,   0,   0,  15,  15 ],
                [ 35,  36,  37,   0,   0,   0,   0,   0,  15,  15,  15 ],
                [ 39,  39,  39,  39,  39,  39,  39,  39,  39,  39,  39 ]
            ];


            // When loading from an array, make sure to specify the tileWidth and tileHeight
            let map = this.make.tilemap({ data: level, tileWidth: 16, tileHeight: 16});
            let tiles = map.addTilesetImage("mario-tiles");
            //createStaticLayer (layer array index value, tileset, x position(optional), y position(optional))
            let layer = map.createDynamicLayer(0, tiles, 0, 0);
            layer.displayWidth = window.innerWidth;
            layer.displayHeight = window.innerHeight;
            map.setCollision([13, 14, 15, 39]);

            //Player creation
            player = this.physics.add.sprite(400, 300, 'idle1');
            player.setScale(0.12, 0.12);

            //Player animation when walking left. Repeat:-1 is a loop.
            // https://photonstorm.github.io/phaser3-docs/Phaser.GameObjects.Components.Animation.html
            this.anims.create({
                key: 'right',
                frames: [
                    { key: 'run1'},
                    { key: 'run2'},
                    { key: 'run3'},
                    { key: 'run4'},
                    { key: 'run5'},
                    { key: 'run6'},
                    { key: 'run7'},
                    { key: 'run8'},
                    { key: 'run9'},
                    { key: 'run10'}
                ],
                frameRate: 20,
                repeat: -1
            });

            //Player faces user when no movement is inputted.
            this.anims.create({
                key: 'turn',
                frames: [
                    { key: 'idle1'},
                    { key: 'idle2'},
                    { key: 'idle3'},
                    { key: 'idle4'},
                    { key: 'idle5'},
                    { key: 'idle6'},
                    { key: 'idle7'},
                    { key: 'idle8'},
                    { key: 'idle9'},
                    { key: 'idle10'}
                ],
                frameRate: 10,
                repeat: -1
            });

            this.physics.add.collider(player, layer);
            player.setCollideWorldBounds(true);
        }

        function update(time, delta) {
            // Runs once per frame for the duration of the scene
            if (game.input.activePointer.isDown)
            {
                this.physics.moveTo(player, game.input.activePointer.x, game.input.activePointer.y, 750);
                if (Math.abs(player.x - game.input.activePointer.x) < player.x*0.05 && Math.abs(player.y - game.input.activePointer.y) < player.y*0.05) {
                    {
                        player.body.velocity.setTo(0, 0);
                        player.anims.play('turn', true);
                    }
                }
                else if (player.x < game.input.activePointer.x)
                {
                    player.flipX = false;
                    player.anims.play('right', true);
                }
                else {
                    player.flipX = true;
                    player.anims.play('right', true);
                }
            }
            else
            {
                player.anims.play('turn', true);
                player.body.velocity.setTo(0, 0);
            }
        }

    </script>




</body>
</html>
